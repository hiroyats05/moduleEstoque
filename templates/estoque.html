<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Materiais, Equipamentos e APIs - Sistema de Estoque</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="container mt-3">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<div class="container mt-4">
    <h1 class="mb-4">Materiais, Equipamentos e APIs</h1>

    <!-- Filtros -->
    <form method="get" class="row g-2 mb-3">
        <div class="col-md-4">
            <input type="text" name="busca" class="form-control" placeholder="Buscar por nome" value="{{ busca }}">
        </div>
        <div class="col-md-3">
            <select name="tipo" class="form-select">
                <option value="">Todos os Tipos</option>
                <option value="Material" {% if tipo == 'Material' %}selected{% endif %}>Material</option>
                <option value="Equipamento" {% if tipo == 'Equipamento' %}selected{% endif %}>Equipamento</option>
                <option value="API" {% if tipo == 'API' %}selected{% endif %}>API</option>
            </select>
        </div>
        <div class="col-md-3">
            <select name="ordem" class="form-select">
                <option value="asc" {% if ordem == 'asc' %}selected{% endif %}>Quantidade Crescente</option>
                <option value="desc" {% if ordem == 'desc' %}selected{% endif %}>Quantidade Decrescente</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Filtrar</button>
        </div>
    </form>

    <!-- Tabela Principal -->
    <table class="table table-bordered table-hover">
        <thead class="table-light">
            <tr>
                <th>Nome</th>
                <th>Quantidade</th>
                <th>Unidade</th>
                <th>Local</th>
                <th>Tipo</th>
                <th>Origem</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% if produtos %}
                {% for produto in produtos %}
                <tr>
                    <td>{{ produto.nome }}</td>
                    <td>{{ produto.quantidade }}</td>
                    <td>{{ produto.unidade_medida }}</td>
                    <td>{{ produto.local_produto }}</td>
                    <td>{{ produto.tipo }}</td>
                    <td>
                        {% if produto.tipo == 'Equipamento' %}
                            {{ produto.origem or '—' }}
                        {% else %}
                            — 
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('editar', id=produto.id) }}" class="btn btn-warning btn-sm">Editar</a>
                        <a href="{{ url_for('excluir', id=produto.id) }}" class="btn btn-danger btn-sm"
                           onclick="return confirm('Tem certeza que deseja excluir este item?')">Excluir</a>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="8" class="text-center text-muted">Nenhum produto cadastrado ainda.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    <!-- Equipamentos Danificados Separados -->
    {% if equipamentos_danificados %}
    <h2 class="mt-5 text-danger">Equipamentos Danificados</h2>
    <table class="table table-bordered table-hover table-danger">
        <thead class="table-light">
            <tr>
                <th>Nome</th>
                <th>Quantidade</th>
                <th>Unidade</th>
                <th>Origem</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for item in equipamentos_danificados %}
            <tr>
                <td>{{ item.nome }}</td>
                <td>{{ item.quantidade }}</td>
                <td>{{ item.unidade_medida }}</td>
                <td>{{ item.origem or '—' }}</td>
                <td>
                    <a href="{{ url_for('excluir_danificado', id=item.id) }}" class="btn btn-danger btn-sm" onclick="return confirm('Tem certeza que deseja excluir este equipamento danificado?')">Excluir</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <!-- Adição de Produto -->
    <hr>
    <h2>Adicionar Produto</h2>
    <form method="POST" action="{{ url_for('adicionar_produto') }}" class="mt-3">
        <div class="mb-3">
            <label for="nome" class="form-label">Nome:</label>
            <input type="text" name="nome" id="nome" class="form-control" placeholder="Nome do Item" required>
        </div>
        <div class="mb-3">
            <label for="quantidade" class="form-label">Quantidade:</label>
            <input type="number" name="quantidade" id="quantidade" class="form-control" placeholder="Quantidade" required>
        </div>
        <div class="mb-3">
            <label for="unidade_medida" class="form-label">Unidade de Medida:</label>
            <select name="unidade_medida" id="unidade_medida" class="form-select" required>
                <option value="" disabled selected hidden>Escolha a unidade</option>
                <option value="unidades">Unidades</option>
                <option value="kg">kg</option>
                <option value="m²">m²</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="tipo" class="form-label">Tipo:</label>
            <select name="tipo" id="tipo" class="form-select" required onchange="mostrarOrigem(this.value)">
                <option value="" disabled selected hidden>Escolha uma opção</option>
                <option value="Material">Material</option>
                <option value="Equipamento">Equipamento</option>
                <option value="API">API</option>
            </select>
        </div>
        
        <div class="mb-3">
            <label for="local_produto" class="form-label">Local do Produto:</label>
            <select name="local_produto" id="local_produto" class="form-select">
                <option value="Estoque Geral" selected>Estoque Geral</option>
                <option value="Depósito A">Depósito A</option>
                <option value="Depósito B">Depósito B</option>
                <option value="Obra 1">Obra 1</option>
                <option value="Obra 2">Obra 2</option>
                <option value="Almoxarifado Central">Almoxarifado Central</option>
                <option value="Setor de Equipamentos">Setor de Equipamentos</option>
                <option value="Outro">Outro</option>
            </select>
        </div>

        <!-- Origem do Equipamento -->
        <div class="mb-3" id="origemDiv" style="display:none;">
            <label class="form-label">Origem do Equipamento:</label><br>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="origem" id="comprado" value="Comprado">
                <label class="form-check-label" for="comprado">Comprado</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="origem" id="alugado" value="Alugado">
                <label class="form-check-label" for="alugado">Alugado</label>
            </div>
        </div>
        <button type="submit" class="btn btn-success">Adicionar</button>
    </form>

    <script>
        function mostrarOrigem(tipo) {
            const origemDiv = document.getElementById('origemDiv');
            if (tipo === 'Equipamento') {
                origemDiv.style.display = 'block';
            } else {
                origemDiv.style.display = 'none';
                document.getElementById('comprado').checked = false;
                document.getElementById('alugado').checked = false;
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const tipoSelect = document.getElementById('tipo');
            if (tipoSelect) {
                mostrarOrigem(tipoSelect.value);
            }
        });
    </script>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Auto-hide flash messages after 3 seconds
setTimeout(() => {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
        alert.classList.remove('show');
        setTimeout(() => alert.remove(), 500);
    });
}, 3000);
</script>
</body>
</html>
